<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroCare AI â€“ Crop & Chat Assistant</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<style>
body { font-family: Arial; background:#eef7ee; padding:20px; text-align:center; }
h1 { color:#2ecc71; }
input, button { padding:10px; margin:5px; border-radius:5px; }
button { background:#2ecc71; color:white; border:none; cursor:pointer; }
#resultText, #description, #chatMessages { margin-top:10px; font-weight:bold; text-align:left; max-width:500px; margin-left:auto; margin-right:auto; }
.bot { color: #2c3e50; }
.user { color:#27ae60; }
</style>
</head>
<body>

<h1>ðŸŒ± AgroCare AI</h1>

<h2>Leaf Disease Detection</h2>
<input type="file" id="imageInput" accept="image/*">
<button id="detectBtn">Detect Disease</button>
<div id="resultText">Result: Waiting for image...</div>
<div id="description"></div>
<img id="leafImage" style="display:none;">

<hr>

<h2>Chat with Agriculture Assistant</h2>
<div id="chatMessages" style="border:1px solid #ccc; padding:10px; height:250px; overflow-y:auto;"></div>
<input id="chatInput" placeholder="Ask about crops, soil, pests..." style="width:300px;">
<button id="chatSendBtn">Send</button>

<script>
/* ====== TensorFlow Model for Leaf Detection ====== */
const imageInput = document.getElementById("imageInput");
const detectBtn = document.getElementById("detectBtn");
const resultText = document.getElementById("resultText");
const descriptionDiv = document.getElementById("description");
const leafImage = document.getElementById("leafImage");

let model;
const CLASS_NAMES = ["Leaf Spot Disease","Powdery Mildew","Blight","Rust Disease","Healthy Leaf ðŸŒ¿"];
const DESCRIPTIONS = {
  "Leaf Spot Disease":"Small, dark spots appear on leaves. Remove affected leaves and use fungicides.",
  "Powdery Mildew":"White powdery coating on leaves. Improve airflow and apply fungicides.",
  "Blight":"Rapid browning of leaves and stems. Remove infected plants and apply treatment.",
  "Rust Disease":"Orange pustules on leaves. Reduces photosynthesis. Apply fungicides.",
  "Healthy Leaf ðŸŒ¿":"No disease detected. Leaf is healthy."
};

async function loadModel(){
  resultText.textContent = "Loading AI model...";
  model = await tf.loadLayersModel("model/model.json"); // adjust path
  resultText.textContent = "Model loaded. Upload an image.";
}
loadModel();

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => leafImage.src = e.target.result;
  reader.readAsDataURL(file);
});

detectBtn.addEventListener("click", async () => {
  if(!model) return alert("Model not loaded");
  if(!leafImage.src) return alert("Upload an image first");

  resultText.textContent = "Detecting...";
  descriptionDiv.textContent = "";

  try {
    const tensor = tf.browser.fromPixels(leafImage)
      .resizeNearestNeighbor([512,512])
      .mean(2)
      .expandDims(0)
      .expandDims(-1)
      .toFloat()
      .div(255);

    const prediction = model.predict(tensor);
    const scores = Array.isArray(prediction) ? prediction[0].dataSync() : prediction.dataSync();

    const maxIndex = scores.indexOf(Math.max(...scores));
    const confidence = (scores[maxIndex]*100).toFixed(2);
    const detectedClass = CLASS_NAMES[maxIndex];

    resultText.textContent = `Detected: ${detectedClass} (${confidence}%)`;
    descriptionDiv.textContent = confidence >= 60 ? DESCRIPTIONS[detectedClass] : "Confidence too low.";

    tf.dispose([tensor, prediction]);
  } catch(err){
    console.error(err);
    resultText.textContent = "Prediction failed!";
    descriptionDiv.textContent = "Check if image is clear.";
  }
});

/* ====== Chatbot connected to Worker ====== */
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const chatMessages = document.getElementById("chatMessages");

// Replace with your worker URL
const WORKER_URL = "https://agriculture-assistant.mikiyasteshome749.workers.dev";

function appendChatMessage(text, sender){
  const div = document.createElement("div");
  div.textContent = (sender==="user"?"You: ":"Assistant: ") + text;
  div.className = sender;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChatMessage(){
  const message = chatInput.value.trim();
  if(!message) return;
  appendChatMessage(message,"user");
  chatInput.value = "";

  appendChatMessage("Typing...","bot");
  const botDiv = chatMessages.lastChild;

  try{
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ message })
    });

    if(!res.ok) throw new Error(`Worker error: ${res.status}`);
    const data = await res.json();
    botDiv.textContent = "Assistant: " + (data.reply || "I could not generate a reply.");
  }catch(err){
    console.error(err);
    botDiv.textContent = "Assistant: âš ï¸ Error connecting to server.";
  }
}

chatSendBtn.addEventListener("click", sendChatMessage);
chatInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendChatMessage(); });
</script>

</body>
</html>
